# 海龟汤功能交接文档

## 📋 项目概述

本项目在原有的 Cloudflare Workers 聊天室基础上，新增了"海龟汤"多人轮流发言功能。海龟汤是一种推理游戏，需要多人轮流发言，一人一句话进行互动。

### 基础架构
- **前端**: HTML + JavaScript (ES6)
- **后端**: Cloudflare Workers + Durable Objects
- **通信**: WebSocket 实时通信
- **部署**: Cloudflare Workers 平台

## 🎯 功能特性

### 1. 海龟汤发起
- 任何用户可点击"🐢 发起海龟汤"按钮
- 需要至少 2 人在线才能发起
- 发起后其他用户会收到确认对话框

### 2. 确认机制
- 所有在线用户（除发起人）需要确认参与
- 所有人确认后自动开始海龟汤
- 任何人拒绝则取消整个活动
- 30秒超时自动取消

### 3. 轮流发言
- 按参与者顺序轮流发言
- 一人一句话，发完自动轮到下一个
- 非当前发言者输入框被禁用
- 实时显示当前发言者

### 4. 状态管理
- 顶部显示海龟汤状态栏
- 显示"轮到你发言"或"轮到XXX发言"
- 发起人可随时结束海龟汤

## 🏗️ 技术实现

### 前端实现 (src/chat.html)

#### 核心变量
```javascript
// 海龟汤状态管理
let turtleSoupActive = false;          // 是否进行中
let turtleSoupParticipants = [];       // 参与者列表
let currentTurnIndex = 0;              // 当前轮次索引
let turtleSoupInitiator = null;        // 发起人
let pendingConfirmations = new Set();  // 待确认用户
let confirmationTimeout = null;        // 确认超时定时器
let hasResponded = false;              // 是否已响应确认
```

#### 主要函数

**发起海龟汤**
```javascript
function initiateTurtleSoup()
```
- 检查在线人数和状态
- 防止重复发起
- 发送发起请求到服务器

**处理确认请求**
```javascript
function handleTurtleSoupRequest(data)
```
- 显示确认对话框
- 防止重复响应
- 发送确认结果到服务器

**开始海龟汤**
```javascript
function handleTurtleSoupStart(data)
```
- 更新本地状态
- 显示海龟汤UI
- 初始化轮次显示

**轮次变更**
```javascript
function handleTurnChange(data)
function updateTurnDisplay()
```
- 更新当前轮次
- 启用/禁用输入框
- 更新UI显示

**发送消息**
```javascript
function sendMessage()
```
- 检查是否为当前发言者
- 添加海龟汤消息标志
- 发送到服务器

### 后端实现 (src/chat.mjs)

#### 状态管理
```javascript
// ChatRoom 类中的状态
this.turtleSoupActive = false;                    // 海龟汤状态
this.turtleSoupParticipants = [];                 // 参与者列表
this.turtleSoupInitiator = null;                  // 发起人
this.currentTurnIndex = 0;                        // 当前轮次
this.pendingConfirmations = new Map();            // 确认状态管理
```

#### 核心方法

**处理发起请求**
```javascript
handleTurtleSoupRequest(session, data)
```
- 验证状态和重复请求
- 获取在线用户列表（去重）
- 广播确认请求
- 设置超时机制

**处理确认响应**
```javascript
handleTurtleSoupConfirmation(session, data)
```
- 防止重复确认
- 统计确认数量
- 达到要求时自动开始

**开始海龟汤**
```javascript
startTurtleSoup(initiator, participants)
```
- 设置服务器状态
- 广播开始消息
- 初始化轮次

**消息处理增强**
```javascript
async webSocketMessage(webSocket, msg)
```
- 识别海龟汤消息标志
- 验证发言轮次
- 自动切换到下一个发言者
- 广播轮次变更

## 📡 消息协议

### 客户端到服务器

**发起海龟汤**
```json
{
  "turtleSoupRequest": true,
  "initiator": "用户名",
  "participants": ["用户1", "用户2"]
}
```

**确认参与**
```json
{
  "turtleSoupConfirm": true,
  "initiator": "发起人",
  "confirmed": true/false,
  "user": "当前用户"
}
```

**海龟汤消息**
```json
{
  "message": "发言内容",
  "turtleSoupMessage": true,
  "turnComplete": true
}
```

**结束海龟汤**
```json
{
  "turtleSoupEnd": true,
  "initiator": "发起人"
}
```

### 服务器到客户端

**确认请求**
```json
{
  "turtleSoupRequest": true,
  "initiator": "发起人",
  "participants": ["用户1", "用户2"]
}
```

**确认反馈**
```json
{
  "turtleSoupConfirm": true,
  "initiator": "发起人",
  "confirmed": true/false,
  "user": "确认用户"
}
```

**开始海龟汤**
```json
{
  "turtleSoupStart": true,
  "initiator": "发起人",
  "participants": ["用户1", "用户2"]
}
```

**轮次变更**
```json
{
  "turtleSoupTurnChange": true,
  "turnIndex": 1,
  "nextPlayer": "下一个发言者"
}
```

**结束海龟汤**
```json
{
  "turtleSoupEnd": true
}
```

## 🎨 UI/UX 设计

### CSS 样式类
- `.turtle-soup-btn`: 发起按钮样式
- `.turtle-soup-status`: 状态栏样式
- `.turtle-soup-mode`: 海龟汤模式下的页面样式
- `.turn-indicator-pulse`: 轮到发言时的动画效果

### 响应式设计
- 支持移动端自适应
- 状态栏在移动端垂直布局
- 动画效果和过渡效果

## 🔧 关键技术细节

### 1. 防重复机制
- 客户端按钮禁用防止重复发起
- 服务器端检查pending状态防止重复处理
- 确认响应防重复标志

### 2. 状态同步
- 服务器端为权威数据源
- 客户端仅响应服务器端状态变更
- 实时WebSocket通信保证同步

### 3. 错误处理
- 网络断开自动重连
- 超时机制防止死锁
- 详细的错误日志

### 4. 轮次管理
- 服务器端统一管理轮次切换
- 客户端仅负责UI更新
- 循环轮次算法 `(index + 1) % participants.length`

## 🐛 调试和日志

### 客户端日志前缀
- `[TurtleSoup Client]`: 海龟汤相关操作

### 服务器端日志前缀
- `[TurtleSoup]`: 海龟汤相关处理

### 关键调试点
1. 发起请求的参与者列表
2. 确认统计和状态检查
3. 轮次切换的逻辑验证
4. WebSocket消息的完整性

## 🚀 部署说明

### 环境要求
- Cloudflare Workers 账号
- Durable Objects 支持
- Wrangler CLI 工具

### 部署步骤
1. 确保 `wrangler.toml` 配置正确
2. 运行 `wrangler deploy` 部署到生产环境
3. 或运行 `wrangler dev` 进行本地开发

### 配置文件
```toml
# wrangler.toml 中的相关配置
[[durable_objects.bindings]]
name = "rooms"
class_name = "ChatRoom"
```

## 📋 待优化项

### 功能增强
1. 支持自定义发言时间限制
2. 支持投票踢出不活跃用户
3. 支持保存海龟汤历史记录
4. 支持观察者模式（只看不参与）

### 性能优化
1. 减少不必要的WebSocket消息
2. 优化大量用户场景的性能
3. 添加消息去重机制

### 用户体验
1. 添加音效提醒
2. 支持表情和快捷回复
3. 更丰富的动画效果
4. 移动端手势支持

## 🔍 故障排查

### 常见问题

**1. 发起后没有收到确认对话框**
- 检查 WebSocket 连接状态
- 确认参与者列表是否正确
- 查看服务器日志确认消息广播

**2. 确认后没有开始海龟汤**
- 检查确认统计逻辑
- 确认参与者数量计算
- 查看超时设置

**3. 发言后没有轮到下一个人**
- 检查消息的 `turtleSoupMessage` 标志
- 确认轮次索引计算
- 查看轮次变更广播

**4. UI 显示异常**
- 检查状态变量同步
- 确认CSS类应用
- 查看控制台错误

### 调试工具
- 浏览器开发者工具控制台
- Cloudflare Workers 日志面板
- WebSocket 连接监控

## 📞 联系信息

如有技术问题或需要进一步支持，请联系开发团队。

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**维护者**: 开发团队