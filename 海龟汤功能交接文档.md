# æµ·é¾Ÿæ±¤åŠŸèƒ½äº¤æ¥æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®åœ¨åŸæœ‰çš„ Cloudflare Workers èŠå¤©å®¤åŸºç¡€ä¸Šï¼Œæ–°å¢äº†"æµ·é¾Ÿæ±¤"å¤šäººè½®æµå‘è¨€åŠŸèƒ½ã€‚æµ·é¾Ÿæ±¤æ˜¯ä¸€ç§æ¨ç†æ¸¸æˆï¼Œéœ€è¦å¤šäººè½®æµå‘è¨€ï¼Œä¸€äººä¸€å¥è¯è¿›è¡Œäº’åŠ¨ã€‚

### åŸºç¡€æ¶æ„
- **å‰ç«¯**: HTML + JavaScript (ES6)
- **åç«¯**: Cloudflare Workers + Durable Objects
- **é€šä¿¡**: WebSocket å®æ—¶é€šä¿¡
- **éƒ¨ç½²**: Cloudflare Workers å¹³å°

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. æµ·é¾Ÿæ±¤å‘èµ·
- ä»»ä½•ç”¨æˆ·å¯ç‚¹å‡»"ğŸ¢ å‘èµ·æµ·é¾Ÿæ±¤"æŒ‰é’®
- éœ€è¦è‡³å°‘ 2 äººåœ¨çº¿æ‰èƒ½å‘èµ·
- å‘èµ·åå…¶ä»–ç”¨æˆ·ä¼šæ”¶åˆ°ç¡®è®¤å¯¹è¯æ¡†

### 2. ç¡®è®¤æœºåˆ¶
- æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆé™¤å‘èµ·äººï¼‰éœ€è¦ç¡®è®¤å‚ä¸
- æ‰€æœ‰äººç¡®è®¤åè‡ªåŠ¨å¼€å§‹æµ·é¾Ÿæ±¤
- ä»»ä½•äººæ‹’ç»åˆ™å–æ¶ˆæ•´ä¸ªæ´»åŠ¨
- 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

### 3. è½®æµå‘è¨€
- æŒ‰å‚ä¸è€…é¡ºåºè½®æµå‘è¨€
- ä¸€äººä¸€å¥è¯ï¼Œå‘å®Œè‡ªåŠ¨è½®åˆ°ä¸‹ä¸€ä¸ª
- éå½“å‰å‘è¨€è€…è¾“å…¥æ¡†è¢«ç¦ç”¨
- å®æ—¶æ˜¾ç¤ºå½“å‰å‘è¨€è€…

### 4. çŠ¶æ€ç®¡ç†
- é¡¶éƒ¨æ˜¾ç¤ºæµ·é¾Ÿæ±¤çŠ¶æ€æ 
- æ˜¾ç¤º"è½®åˆ°ä½ å‘è¨€"æˆ–"è½®åˆ°XXXå‘è¨€"
- å‘èµ·äººå¯éšæ—¶ç»“æŸæµ·é¾Ÿæ±¤

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### å‰ç«¯å®ç° (src/chat.html)

#### æ ¸å¿ƒå˜é‡
```javascript
// æµ·é¾Ÿæ±¤çŠ¶æ€ç®¡ç†
let turtleSoupActive = false;          // æ˜¯å¦è¿›è¡Œä¸­
let turtleSoupParticipants = [];       // å‚ä¸è€…åˆ—è¡¨
let currentTurnIndex = 0;              // å½“å‰è½®æ¬¡ç´¢å¼•
let turtleSoupInitiator = null;        // å‘èµ·äºº
let pendingConfirmations = new Set();  // å¾…ç¡®è®¤ç”¨æˆ·
let confirmationTimeout = null;        // ç¡®è®¤è¶…æ—¶å®šæ—¶å™¨
let hasResponded = false;              // æ˜¯å¦å·²å“åº”ç¡®è®¤
```

#### ä¸»è¦å‡½æ•°

**å‘èµ·æµ·é¾Ÿæ±¤**
```javascript
function initiateTurtleSoup()
```
- æ£€æŸ¥åœ¨çº¿äººæ•°å’ŒçŠ¶æ€
- é˜²æ­¢é‡å¤å‘èµ·
- å‘é€å‘èµ·è¯·æ±‚åˆ°æœåŠ¡å™¨

**å¤„ç†ç¡®è®¤è¯·æ±‚**
```javascript
function handleTurtleSoupRequest(data)
```
- æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- é˜²æ­¢é‡å¤å“åº”
- å‘é€ç¡®è®¤ç»“æœåˆ°æœåŠ¡å™¨

**å¼€å§‹æµ·é¾Ÿæ±¤**
```javascript
function handleTurtleSoupStart(data)
```
- æ›´æ–°æœ¬åœ°çŠ¶æ€
- æ˜¾ç¤ºæµ·é¾Ÿæ±¤UI
- åˆå§‹åŒ–è½®æ¬¡æ˜¾ç¤º

**è½®æ¬¡å˜æ›´**
```javascript
function handleTurnChange(data)
function updateTurnDisplay()
```
- æ›´æ–°å½“å‰è½®æ¬¡
- å¯ç”¨/ç¦ç”¨è¾“å…¥æ¡†
- æ›´æ–°UIæ˜¾ç¤º

**å‘é€æ¶ˆæ¯**
```javascript
function sendMessage()
```
- æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰å‘è¨€è€…
- æ·»åŠ æµ·é¾Ÿæ±¤æ¶ˆæ¯æ ‡å¿—
- å‘é€åˆ°æœåŠ¡å™¨

### åç«¯å®ç° (src/chat.mjs)

#### çŠ¶æ€ç®¡ç†
```javascript
// ChatRoom ç±»ä¸­çš„çŠ¶æ€
this.turtleSoupActive = false;                    // æµ·é¾Ÿæ±¤çŠ¶æ€
this.turtleSoupParticipants = [];                 // å‚ä¸è€…åˆ—è¡¨
this.turtleSoupInitiator = null;                  // å‘èµ·äºº
this.currentTurnIndex = 0;                        // å½“å‰è½®æ¬¡
this.pendingConfirmations = new Map();            // ç¡®è®¤çŠ¶æ€ç®¡ç†
```

#### æ ¸å¿ƒæ–¹æ³•

**å¤„ç†å‘èµ·è¯·æ±‚**
```javascript
handleTurtleSoupRequest(session, data)
```
- éªŒè¯çŠ¶æ€å’Œé‡å¤è¯·æ±‚
- è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆå»é‡ï¼‰
- å¹¿æ’­ç¡®è®¤è¯·æ±‚
- è®¾ç½®è¶…æ—¶æœºåˆ¶

**å¤„ç†ç¡®è®¤å“åº”**
```javascript
handleTurtleSoupConfirmation(session, data)
```
- é˜²æ­¢é‡å¤ç¡®è®¤
- ç»Ÿè®¡ç¡®è®¤æ•°é‡
- è¾¾åˆ°è¦æ±‚æ—¶è‡ªåŠ¨å¼€å§‹

**å¼€å§‹æµ·é¾Ÿæ±¤**
```javascript
startTurtleSoup(initiator, participants)
```
- è®¾ç½®æœåŠ¡å™¨çŠ¶æ€
- å¹¿æ’­å¼€å§‹æ¶ˆæ¯
- åˆå§‹åŒ–è½®æ¬¡

**æ¶ˆæ¯å¤„ç†å¢å¼º**
```javascript
async webSocketMessage(webSocket, msg)
```
- è¯†åˆ«æµ·é¾Ÿæ±¤æ¶ˆæ¯æ ‡å¿—
- éªŒè¯å‘è¨€è½®æ¬¡
- è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå‘è¨€è€…
- å¹¿æ’­è½®æ¬¡å˜æ›´

## ğŸ“¡ æ¶ˆæ¯åè®®

### å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨

**å‘èµ·æµ·é¾Ÿæ±¤**
```json
{
  "turtleSoupRequest": true,
  "initiator": "ç”¨æˆ·å",
  "participants": ["ç”¨æˆ·1", "ç”¨æˆ·2"]
}
```

**ç¡®è®¤å‚ä¸**
```json
{
  "turtleSoupConfirm": true,
  "initiator": "å‘èµ·äºº",
  "confirmed": true/false,
  "user": "å½“å‰ç”¨æˆ·"
}
```

**æµ·é¾Ÿæ±¤æ¶ˆæ¯**
```json
{
  "message": "å‘è¨€å†…å®¹",
  "turtleSoupMessage": true,
  "turnComplete": true
}
```

**ç»“æŸæµ·é¾Ÿæ±¤**
```json
{
  "turtleSoupEnd": true,
  "initiator": "å‘èµ·äºº"
}
```

### æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯

**ç¡®è®¤è¯·æ±‚**
```json
{
  "turtleSoupRequest": true,
  "initiator": "å‘èµ·äºº",
  "participants": ["ç”¨æˆ·1", "ç”¨æˆ·2"]
}
```

**ç¡®è®¤åé¦ˆ**
```json
{
  "turtleSoupConfirm": true,
  "initiator": "å‘èµ·äºº",
  "confirmed": true/false,
  "user": "ç¡®è®¤ç”¨æˆ·"
}
```

**å¼€å§‹æµ·é¾Ÿæ±¤**
```json
{
  "turtleSoupStart": true,
  "initiator": "å‘èµ·äºº",
  "participants": ["ç”¨æˆ·1", "ç”¨æˆ·2"]
}
```

**è½®æ¬¡å˜æ›´**
```json
{
  "turtleSoupTurnChange": true,
  "turnIndex": 1,
  "nextPlayer": "ä¸‹ä¸€ä¸ªå‘è¨€è€…"
}
```

**ç»“æŸæµ·é¾Ÿæ±¤**
```json
{
  "turtleSoupEnd": true
}
```

## ğŸ¨ UI/UX è®¾è®¡

### CSS æ ·å¼ç±»
- `.turtle-soup-btn`: å‘èµ·æŒ‰é’®æ ·å¼
- `.turtle-soup-status`: çŠ¶æ€æ æ ·å¼
- `.turtle-soup-mode`: æµ·é¾Ÿæ±¤æ¨¡å¼ä¸‹çš„é¡µé¢æ ·å¼
- `.turn-indicator-pulse`: è½®åˆ°å‘è¨€æ—¶çš„åŠ¨ç”»æ•ˆæœ

### å“åº”å¼è®¾è®¡
- æ”¯æŒç§»åŠ¨ç«¯è‡ªé€‚åº”
- çŠ¶æ€æ åœ¨ç§»åŠ¨ç«¯å‚ç›´å¸ƒå±€
- åŠ¨ç”»æ•ˆæœå’Œè¿‡æ¸¡æ•ˆæœ

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. é˜²é‡å¤æœºåˆ¶
- å®¢æˆ·ç«¯æŒ‰é’®ç¦ç”¨é˜²æ­¢é‡å¤å‘èµ·
- æœåŠ¡å™¨ç«¯æ£€æŸ¥pendingçŠ¶æ€é˜²æ­¢é‡å¤å¤„ç†
- ç¡®è®¤å“åº”é˜²é‡å¤æ ‡å¿—

### 2. çŠ¶æ€åŒæ­¥
- æœåŠ¡å™¨ç«¯ä¸ºæƒå¨æ•°æ®æº
- å®¢æˆ·ç«¯ä»…å“åº”æœåŠ¡å™¨ç«¯çŠ¶æ€å˜æ›´
- å®æ—¶WebSocketé€šä¿¡ä¿è¯åŒæ­¥

### 3. é”™è¯¯å¤„ç†
- ç½‘ç»œæ–­å¼€è‡ªåŠ¨é‡è¿
- è¶…æ—¶æœºåˆ¶é˜²æ­¢æ­»é”
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 4. è½®æ¬¡ç®¡ç†
- æœåŠ¡å™¨ç«¯ç»Ÿä¸€ç®¡ç†è½®æ¬¡åˆ‡æ¢
- å®¢æˆ·ç«¯ä»…è´Ÿè´£UIæ›´æ–°
- å¾ªç¯è½®æ¬¡ç®—æ³• `(index + 1) % participants.length`

## ğŸ› è°ƒè¯•å’Œæ—¥å¿—

### å®¢æˆ·ç«¯æ—¥å¿—å‰ç¼€
- `[TurtleSoup Client]`: æµ·é¾Ÿæ±¤ç›¸å…³æ“ä½œ

### æœåŠ¡å™¨ç«¯æ—¥å¿—å‰ç¼€
- `[TurtleSoup]`: æµ·é¾Ÿæ±¤ç›¸å…³å¤„ç†

### å…³é”®è°ƒè¯•ç‚¹
1. å‘èµ·è¯·æ±‚çš„å‚ä¸è€…åˆ—è¡¨
2. ç¡®è®¤ç»Ÿè®¡å’ŒçŠ¶æ€æ£€æŸ¥
3. è½®æ¬¡åˆ‡æ¢çš„é€»è¾‘éªŒè¯
4. WebSocketæ¶ˆæ¯çš„å®Œæ•´æ€§

## ğŸš€ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚
- Cloudflare Workers è´¦å·
- Durable Objects æ”¯æŒ
- Wrangler CLI å·¥å…·

### éƒ¨ç½²æ­¥éª¤
1. ç¡®ä¿ `wrangler.toml` é…ç½®æ­£ç¡®
2. è¿è¡Œ `wrangler deploy` éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
3. æˆ–è¿è¡Œ `wrangler dev` è¿›è¡Œæœ¬åœ°å¼€å‘

### é…ç½®æ–‡ä»¶
```toml
# wrangler.toml ä¸­çš„ç›¸å…³é…ç½®
[[durable_objects.bindings]]
name = "rooms"
class_name = "ChatRoom"
```

## ğŸ“‹ å¾…ä¼˜åŒ–é¡¹

### åŠŸèƒ½å¢å¼º
1. æ”¯æŒè‡ªå®šä¹‰å‘è¨€æ—¶é—´é™åˆ¶
2. æ”¯æŒæŠ•ç¥¨è¸¢å‡ºä¸æ´»è·ƒç”¨æˆ·
3. æ”¯æŒä¿å­˜æµ·é¾Ÿæ±¤å†å²è®°å½•
4. æ”¯æŒè§‚å¯Ÿè€…æ¨¡å¼ï¼ˆåªçœ‹ä¸å‚ä¸ï¼‰

### æ€§èƒ½ä¼˜åŒ–
1. å‡å°‘ä¸å¿…è¦çš„WebSocketæ¶ˆæ¯
2. ä¼˜åŒ–å¤§é‡ç”¨æˆ·åœºæ™¯çš„æ€§èƒ½
3. æ·»åŠ æ¶ˆæ¯å»é‡æœºåˆ¶

### ç”¨æˆ·ä½“éªŒ
1. æ·»åŠ éŸ³æ•ˆæé†’
2. æ”¯æŒè¡¨æƒ…å’Œå¿«æ·å›å¤
3. æ›´ä¸°å¯Œçš„åŠ¨ç”»æ•ˆæœ
4. ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. å‘èµ·åæ²¡æœ‰æ”¶åˆ°ç¡®è®¤å¯¹è¯æ¡†**
- æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
- ç¡®è®¤å‚ä¸è€…åˆ—è¡¨æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤æ¶ˆæ¯å¹¿æ’­

**2. ç¡®è®¤åæ²¡æœ‰å¼€å§‹æµ·é¾Ÿæ±¤**
- æ£€æŸ¥ç¡®è®¤ç»Ÿè®¡é€»è¾‘
- ç¡®è®¤å‚ä¸è€…æ•°é‡è®¡ç®—
- æŸ¥çœ‹è¶…æ—¶è®¾ç½®

**3. å‘è¨€åæ²¡æœ‰è½®åˆ°ä¸‹ä¸€ä¸ªäºº**
- æ£€æŸ¥æ¶ˆæ¯çš„ `turtleSoupMessage` æ ‡å¿—
- ç¡®è®¤è½®æ¬¡ç´¢å¼•è®¡ç®—
- æŸ¥çœ‹è½®æ¬¡å˜æ›´å¹¿æ’­

**4. UI æ˜¾ç¤ºå¼‚å¸¸**
- æ£€æŸ¥çŠ¶æ€å˜é‡åŒæ­¥
- ç¡®è®¤CSSç±»åº”ç”¨
- æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯

### è°ƒè¯•å·¥å…·
- æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ§åˆ¶å°
- Cloudflare Workers æ—¥å¿—é¢æ¿
- WebSocket è¿æ¥ç›‘æ§

## ğŸ“ è”ç³»ä¿¡æ¯

å¦‚æœ‰æŠ€æœ¯é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥æ”¯æŒï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ